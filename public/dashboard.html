<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cloud Concierge - Dashboard</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
          rel="stylesheet" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo"></div>
            </div>
        </div>
    </header>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <div class="logo">
                    <h2>Cloud Concierge</h2>
                </div>
                <ul class="nav-links">
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="profile.html">Profile</a></li>
                    <li><a href="index.html">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Dashboard -->
    <section class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <h1>Welcome to <span id="restaurant-name"></span>'s Dashboard</h1>
            </div>
            <div class="dashboard-content">
                <h2>Sales Dashboard</h2>
                <form id="sales-form">
                    <div class="days-container" id="days-container"></div>

                    <button type="submit" class="btn btn-primary">Submit Sales</button>
                </form>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-about">
                    <h3>About Cloud Concierge</h3>
                    <p>Your AI sales prediction software</p>
                </div>
                <div class="footer-contact">
                    <h3>Contact Info</h3>
                    <p><i class="fas fa-map-marker-alt"></i>1395 Woodroffe Ave, Ottawa ON</p>
                    <p><i class="fas fa-envelope"></i> support@cloudconcierge.com</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Cloud Concierge. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Back to Top -->
    <a href="#" class="back-to-top"><i class="fas fa-arrow-up"></i></a>

    <!-- JavaScript -->
    <script>
        const token = localStorage.getItem("token");
        if (!token) window.location.href = "index.html";

        document.getElementById("restaurant-name").textContent = "Your Restaurant Name";

        // Days array
        const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"];
        const container = document.getElementById("days-container");

        // Generate inputs dynamically
        days.forEach((day) => {
            const capitalized = day.charAt(0).toUpperCase() + day.slice(1);
            container.innerHTML += `
            <div class="day">
              <br />
              <label for="${day}">${capitalized}</label>
              <input
                type="number"
                id="${day}"
                name="${day}"
                placeholder="Enter sales"
                required
              />
            </div>`;
        });

        // Format date as YYYY-MM-DD
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, "0");
            const month = String(date.getMonth() + 1).padStart(2, "0");
            return `${date.getFullYear()}-${month}-${day}`;
        }

        // Get previous week's Monday–Sunday dates
        function getPreviousWeekDates() {
            const current = new Date();
            const dayOfWeek = current.getDay();
            const diffToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            current.setDate(current.getDate() - diffToMonday - 7);
            return Array.from({ length: 7 }, () => {
                const d = new Date(current);
                current.setDate(current.getDate() + 1);
                return formatDate(d);
            });
        }

        // Get next week's Monday–Sunday dates
        function getNextWeekDates() {
            const current = new Date();
            const dayOfWeek = current.getDay();
            const diffToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            current.setDate(current.getDate() - diffToMonday + 7);
            return Array.from({ length: 7 }, () => {
                const d = new Date(current);
                current.setDate(current.getDate() + 1);
                return formatDate(d);
            });
        }
        // Ottawa's coordinates
        const latitude = 45.4215;
        const longitude = -75.6972;

        const lastWeekDates = getPreviousWeekDates();
        const nextWeekDates = getNextWeekDates();

        // Fetch forecast weather (works for past and future dates)
        async function fetchForecastWeather(startDate, endDate) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&start_date=${startDate}&end_date=${endDate}&daily=temperature_2m_max&timezone=America/New_York`;
            const response = await fetch(url);
            const data = await response.json();
            if (!data.daily || !data.daily.temperature_2m_max) {
                console.error("Forecast weather API failed or no data", data);
                return [];
            }
            return data.daily.temperature_2m_max;
        }

        document.getElementById("sales-form").addEventListener("submit", async (e) => {
  e.preventDefault();

  const salesData = Object.fromEntries(
    days.map((day) => [day, Number(document.getElementById(day).value)])
  );

  const [lastTemps, nextTemps] = await Promise.all([
    fetchForecastWeather(lastWeekDates[0], lastWeekDates[6]),
    fetchForecastWeather(nextWeekDates[0], nextWeekDates[6]),
  ]);

  if (!lastTemps.length || !nextTemps.length || lastTemps.length !== 7 || nextTemps.length !== 7) {
    alert("Temperature data not complete.");
    return;
  }

  const predictedSales = {};

  try {
for (let i = 0; i < days.length; i++) {
  const day = days[i];
  const lastTemp = lastTemps[i];
  const nextTemp = nextTemps[i];

  const lastResponse = await fetch("http://localhost:5000/proxy/predict", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ temperature: lastTemp, day }),
  });
  if (!lastResponse.ok) {
    const errorText = await lastResponse.text();
    throw new Error(`Error from server on last week ${day}: ${errorText}`);
  }
  const lastValObj = await lastResponse.json();

  const nextResponse = await fetch("http://localhost:5000/proxy/predict", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ temperature: nextTemp, day }),
  });
  if (!nextResponse.ok) {
    const errorText = await nextResponse.text();
    throw new Error(`Error from server on next week ${day}: ${errorText}`);
  }
  const nextValObj = await nextResponse.json();

  const lastVal = lastValObj.prediction; // adjust to your actual key
  const nextVal = nextValObj.prediction; // adjust to your actual key

  console.log(lastValObj, nextValObj);

  if (typeof lastVal !== "number" || typeof nextVal !== "number") {
    throw new Error(`Invalid prediction values for ${day}`);
  }

  const ratio = nextVal / lastVal;

  predictedSales[day] = Math.round(salesData[day] * ratio);
}for (let i = 0; i < days.length; i++) {
  const day = days[i];
  const lastTemp = lastTemps[i];
  const nextTemp = nextTemps[i];

  const lastResponse = await fetch("http://localhost:5000/proxy/predict", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ temperature: lastTemp, day }),
  });
  if (!lastResponse.ok) {
    const errorText = await lastResponse.text();
    throw new Error(`Error from server on last week ${day}: ${errorText}`);
  }
  const lastValObj = await lastResponse.json();
  console.log(`Last week response for ${day}:`, lastValObj);

  const nextResponse = await fetch("http://localhost:5000/proxy/predict", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ temperature: nextTemp, day }),
  });
  if (!nextResponse.ok) {
    const errorText = await nextResponse.text();
    throw new Error(`Error from server on next week ${day}: ${errorText}`);
  }
  const nextValObj = await nextResponse.json();
  console.log(`Next week response for ${day}:`, nextValObj);

  // Now check what keys you have inside the response objects:
  // For example, if the response looks like { prediction: 123 }
  // You might try:
  const lastVal = lastValObj.prediction ?? lastValObj.value ?? null;
  const nextVal = nextValObj.prediction ?? nextValObj.value ?? null;

  console.log(`Parsed lastVal for ${day}:`, lastVal);
  console.log(`Parsed nextVal for ${day}:`, nextVal);

  if (typeof lastVal !== "number" || typeof nextVal !== "number") {
    throw new Error(`Invalid prediction values for ${day}`);
  }

  const ratio = nextVal / lastVal;
  predictedSales[day] = Math.round(salesData[day] * ratio);
}



    localStorage.setItem("predictedSales", JSON.stringify(predictedSales));
    window.location.href = "restaurant-dashboard.html";

  } catch (error) {
    console.error("Error fetching prediction data:", error);
    alert("Failed to get prediction from server.");
  }
});


    </script>
</body>
</html>
